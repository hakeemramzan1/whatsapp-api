<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Business Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-green: #00a884; --primary-green-hover: #06cf9c; --dark-bg: #0a0f0d;
            --sidebar-bg: #111b21; --panel-bg: #202c33; --hover-bg: #2a3942;
            --border-color: #2a3942; --text-primary: #e9edef; --text-secondary: #8696a0;
            --text-tertiary: #667781; --message-sent: #005c4b; --message-received: #202c33;
            --unread-badge: #25d366; --blue-tick: #53bdeb;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--dark-bg); color: var(--text-primary); height: 100vh; overflow: hidden; }
        .container { display: flex; height: 100vh; }
        .sidebar { width: 380px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .sidebar-header { padding: 18px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .sidebar-header-left h2 { font-size: 19px; font-weight: 600; margin-bottom: 4px; }
        .status-row { display: flex; align-items: center; font-size: 13px; color: var(--text-secondary); gap: 6px; }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; }
        .status-indicator.connected { background: var(--primary-green); }
        .status-indicator.disconnected { background: #f15c6d; }
        .sidebar-header-right { display: flex; gap: 12px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: background 0.2s; }
        .icon-btn:hover { background: var(--hover-bg); }
        .search-box { padding: 10px 16px; background: var(--sidebar-bg); }
        .search-input-wrapper { position: relative; }
        .search-input { width: 100%; padding: 10px 16px 10px 50px; background: var(--panel-bg); border: none; border-radius: 8px; color: var(--text-primary); font-size: 14px; }
        .search-input:focus { outline: 2px solid var(--primary-green); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary); font-size: 18px; }
        .new-chat-btn { margin: 12px 16px; padding: 12px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        .new-chat-btn:hover { background: var(--primary-green-hover); }
        .contacts-list { flex: 1; overflow-y: auto; }
        .contacts-list::-webkit-scrollbar { width: 6px; }
        .contacts-list::-webkit-scrollbar-thumb { background: var(--hover-bg); border-radius: 3px; }
        .contact-item { padding: 14px 20px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 14px; position: relative; }
        .contact-item:hover { background: var(--panel-bg); }
        .contact-item.active { background: var(--hover-bg); }
        .contact-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-green), #128c7e); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600; color: white; flex-shrink: 0; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .contact-name { font-size: 16px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-time { font-size: 12px; color: var(--text-tertiary); }
        .contact-preview { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-badge { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: var(--unread-badge); color: var(--dark-bg); width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; }
        .chat-container { flex: 1; display: flex; flex-direction: column; background: var(--dark-bg); }
        .chat-header { padding: 14px 20px; background: var(--panel-bg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
        .chat-header-left { display: flex; align-items: center; gap: 14px; }
        .mobile-back-btn { display: none; background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 0; }
        .chat-avatar { width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-green), #128c7e); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: white; }
        .chat-info h2 { font-size: 16px; font-weight: 500; margin-bottom: 2px; }
        .chat-status { font-size: 13px; color: var(--text-tertiary); }
        .chat-header-right { display: flex; gap: 12px; }
        .messages-container { flex: 1; overflow-y: auto; padding: 20px; background-image: radial-gradient(circle at 20% 50%, rgba(0, 168, 132, 0.03) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(0, 168, 132, 0.03) 0%, transparent 50%); }
        .messages-container::-webkit-scrollbar { width: 6px; }
        .messages-container::-webkit-scrollbar-thumb { background: var(--hover-bg); border-radius: 3px; }
        .date-divider { text-align: center; margin: 20px 0; }
        .date-divider span { background: var(--panel-bg); padding: 6px 14px; border-radius: 8px; font-size: 12px; color: var(--text-tertiary); }
        .message { max-width: 65%; margin-bottom: 8px; display: flex; flex-direction: column; }
        .message.sent { align-items: flex-end; margin-left: auto; }
        .message.received { align-items: flex-start; margin-right: auto; }
        .message-bubble { padding: 8px 12px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        .message.sent .message-bubble { background: var(--message-sent); border-bottom-right-radius: 2px; }
        .message.received .message-bubble { background: var(--message-received); border-bottom-left-radius: 2px; }
        .message-text { font-size: 14.2px; line-height: 1.5; margin-bottom: 4px; word-wrap: break-word; }
        .message-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 11px; color: rgba(255, 255, 255, 0.6); }
        .message-status.read { color: var(--blue-tick); }
        .input-container { padding: 14px 20px; background: var(--panel-bg); border-top: 1px solid var(--border-color); display: flex; gap: 10px; align-items: flex-end; }
        .message-input { flex: 1; padding: 11px 16px; background: var(--hover-bg); border: none; border-radius: 8px; color: var(--text-primary); font-size: 15px; resize: none; font-family: inherit; max-height: 120px; line-height: 1.5; }
        .message-input:focus { outline: 2px solid var(--primary-green); }
        .send-btn { padding: 11px 24px; background: var(--primary-green); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; transition: background 0.2s; }
        .send-btn:hover { background: var(--primary-green-hover); }
        .send-btn:disabled { background: var(--hover-bg); cursor: not-allowed; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: var(--panel-bg); padding: 28px; border-radius: 12px; width: 440px; max-width: 90%; }
        .modal-content h3 { margin-bottom: 20px; font-size: 20px; font-weight: 600; }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 500; }
        .input-group input, .input-group textarea { width: 100%; padding: 11px 14px; background: var(--hover-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-family: inherit; }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: var(--primary-green); }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .btn { padding: 11px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; flex: 1; }
        .btn-primary { background: var(--primary-green); color: white; }
        .btn-primary:hover { background: var(--primary-green-hover); }
        .btn-secondary { background: var(--hover-bg); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--border-color); }
        .success-message, .error-message { padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 13px; display: none; }
        .success-message { background: rgba(0, 168, 132, 0.2); color: var(--primary-green); }
        .error-message { background: rgba(241, 92, 109, 0.2); color: #f15c6d; }
        .success-message.show, .error-message.show { display: block; }
        .no-results { padding: 40px 20px; text-align: center; color: var(--text-tertiary); font-size: 14px; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary); font-size: 15px; padding: 40px; text-align: center; }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
       @media (max-width: 768px) {
    .sidebar { width: 100%; }
    .sidebar:not(.mobile-visible) { display: none; }
    .sidebar.mobile-visible { display: flex; }
    .chat-container:not(.mobile-visible) { display: none; }
    .chat-container.mobile-visible { display: flex; }
    .mobile-back-btn { display: block; }
    .message { max-width: 80%; }
}
        .settings-panel { background: var(--panel-bg); padding: 20px; border-radius: 12px; margin: 20px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 14px 0; border-bottom: 1px solid var(--border-color); }
        .setting-item:last-child { border-bottom: none; }
        .setting-label { font-size: 14px; }
        .setting-description { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; }
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--hover-bg); transition: 0.3s; border-radius: 24px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
        .toggle-switch input:checked + .toggle-slider { background-color: var(--primary-green); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }
        .quick-replies-panel { position: absolute; bottom: 70px; left: 20px; right: 20px; background: var(--panel-bg); border-radius: 12px; padding: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); display: none; max-height: 300px; overflow-y: auto; }
        .quick-replies-panel.active { display: block; }
        .quick-reply-item { padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; margin-bottom: 4px; }
        .quick-reply-item:hover { background: var(--hover-bg); }
        .quick-reply-title { font-size: 14px; font-weight: 500; margin-bottom: 4px; }
        .quick-reply-text { font-size: 12px; color: var(--text-secondary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-left">
                    <div>
                        <h2>Messages</h2>
                        <div class="status-row">
                            <span class="status-indicator disconnected" id="statusIndicator"></span>
                            <span id="statusText">Not Connected</span>
                        </div>
                    </div>
                </div>
                <div class="sidebar-header-right">
                    <button class="icon-btn" onclick="openSettingsModal()">‚öôÔ∏è</button>
                    <button class="icon-btn" onclick="openQuickRepliesModal()">üí¨</button>
                </div>
            </div>
            <div class="search-box">
                <div class="search-input-wrapper">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search..." oninput="handleSearch()">
                </div>
            </div>
            <button class="new-chat-btn" onclick="openNewChatModal()">+ New Chat</button>
            <div class="contacts-list" id="contactsList">
                <div class="no-results">No contacts yet</div>
            </div>
        </div>
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="mobile-back-btn" onclick="showSidebar()">‚Üê</button>
                    <div class="chat-avatar" id="chatAvatar">?</div>
                    <div class="chat-info">
                        <h2 id="chatName">Select a contact</h2>
                        <div class="chat-status" id="chatStatus"></div>
                    </div>
                </div>
                <div class="chat-header-right">
                    <button class="icon-btn" onclick="markAsUnread()">üì≠</button>
                    <button class="icon-btn" onclick="toggleQuickReplies()">‚ö°</button>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üí¨</div>
                    <div>Select a contact</div>
                </div>
            </div>
            <div class="quick-replies-panel" id="quickRepliesPanel"></div>
            <div class="input-container">
                <textarea class="message-input" id="messageInput" placeholder="Type a message" rows="1" disabled oninput="handleTyping()"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>Send</button>
            </div>
        </div>
    </div>
    <div class="modal" id="newChatModal">
        <div class="modal-content">
            <h3>Start New Chat</h3>
            <div class="input-group">
                <label>Phone Number</label>
                <input type="text" id="newChatNumber" placeholder="e.g., 971501234567">
            </div>
            <div class="input-group">
                <label>Contact Name</label>
                <input type="text" id="newChatName" placeholder="e.g., John Doe">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="createNewChat()">Start</button>
                <button class="btn btn-secondary" onclick="closeModal('newChatModal')">Cancel</button>
            </div>
        </div>
    </div>
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h3>Settings</h3>
            <div class="input-group">
                <label>Phone Number ID</label>
                <input type="text" id="phoneNumberId" placeholder="15-digit number">
            </div>
            <div class="input-group">
                <label>Access Token</label>
                <input type="password" id="accessToken" placeholder="Token">
            </div>
            <div class="settings-panel">
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Sound Notifications</div>
                        <div class="setting-description">Play sound on messages</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle" checked onchange="toggleSound()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div>
                        <div class="setting-label">Desktop Notifications</div>
                        <div class="setting-description">Show browser notifications</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="desktopNotifToggle" checked onchange="toggleDesktopNotif()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveSettings()">Save</button>
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">Cancel</button>
            </div>
            <div class="success-message" id="settingsSuccess"></div>
            <div class="error-message" id="settingsError"></div>
        </div>
    </div>
    <div class="modal" id="quickRepliesModal">
        <div class="modal-content">
            <h3>Quick Replies</h3>
            <div id="quickRepliesList"></div>
            <button class="btn btn-primary" onclick="addQuickReply()" style="margin-top:16px">+ Add</button>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('quickRepliesModal')">Close</button>
            </div>
        </div>
    </div>
    <script>
        let state = { contacts: {}, activeContact: null, settings: { soundEnabled: true, desktopNotifEnabled: true, quickReplies: [] }, typingTimeout: null };
        const notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ4KU6Pn77BdGAg+ltryxnYpBSp+zPDaizsIGGS36+mihEAcLHLG79ydTgwKWKjn6MqCPAYVZ7Lv46tWEAYYh9Xyzn8sBil70fHcjT4I');
        function init() { loadSettings(); loadContacts(); checkConfig(); requestNotificationPermission(); setInterval(pollMessages, 3000); setInterval(syncContacts, 5000); }
        function loadSettings() {
            const saved = localStorage.getItem('whatsappSettings');
            if (saved) { state.settings = { ...state.settings, ...JSON.parse(saved) }; document.getElementById('soundToggle').checked = state.settings.soundEnabled; document.getElementById('desktopNotifToggle').checked = state.settings.desktopNotifEnabled; }
            const config = localStorage.getItem('whatsappApiConfig');
            if (config) { const { phoneNumberId, accessToken } = JSON.parse(config); document.getElementById('phoneNumberId').value = phoneNumberId || ''; document.getElementById('accessToken').value = accessToken || ''; if (phoneNumberId && accessToken) saveConfig(phoneNumberId, accessToken); }
        }
        function saveSettings() {
            const phoneNumberId = document.getElementById('phoneNumberId').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();
            if (!phoneNumberId || !accessToken) { showMessage('settingsError', 'Fill all fields'); return; }
            localStorage.setItem('whatsappApiConfig', JSON.stringify({ phoneNumberId, accessToken }));
            localStorage.setItem('whatsappSettings', JSON.stringify(state.settings));
            saveConfig(phoneNumberId, accessToken);
        }
        async function saveConfig(phoneNumberId, accessToken) {
            try {
                const response = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ phoneNumberId, accessToken }) });
                if (response.ok) { showMessage('settingsSuccess', 'Saved!'); updateStatus(true); setTimeout(() => closeModal('settingsModal'), 1500); } else showMessage('settingsError', 'Failed');
            } catch (error) { showMessage('settingsError', 'Network error'); }
        }
        async function checkConfig() { try { const response = await fetch('/api/config'); const data = await response.json(); updateStatus(data.configured); } catch (error) {} }
        function updateStatus(connected) { document.getElementById('statusIndicator').className = 'status-indicator ' + (connected ? 'connected' : 'disconnected'); document.getElementById('statusText').textContent = connected ? 'Connected' : 'Not Connected'; }
        function loadContacts() { const saved = localStorage.getItem('whatsappContacts'); if (saved) { state.contacts = JSON.parse(saved); renderContacts(); } syncContacts(); }
        async function syncContacts() {
            try {
                const response = await fetch('/api/contacts');
                const data = await response.json();
                data.contacts.forEach(contact => {
                    if (!state.contacts[contact.number]) state.contacts[contact.number] = { number: contact.number, name: contact.name || contact.number, lastMessage: contact.lastMessage || '', lastMessageTime: contact.lastMessageTime || Date.now(), unreadCount: contact.unreadCount || 0 };
                    else state.contacts[contact.number] = { ...state.contacts[contact.number], lastMessage: contact.lastMessage || state.contacts[contact.number].lastMessage, lastMessageTime: contact.lastMessageTime || state.contacts[contact.number].lastMessageTime, unreadCount: contact.unreadCount || 0 };
                });
                saveContactsToStorage(); renderContacts();
                if (state.activeContact) loadMessages(state.activeContact);
            } catch (error) {}
        }
        function saveContactsToStorage() { localStorage.setItem('whatsappContacts', JSON.stringify(state.contacts)); }
        function renderContacts() {
            const list = document.getElementById('contactsList');
            const contacts = Object.values(state.contacts).sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0));
            if (contacts.length === 0) { list.innerHTML = '<div class="no-results">No contacts yet</div>'; return; }
            list.innerHTML = contacts.map(contact => {
                const initials = getInitials(contact.name);
                const time = formatTime(contact.lastMessageTime);
                const isActive = state.activeContact === contact.number;
                return `<div class="contact-item ${isActive ? 'active' : ''}" onclick="selectContact('${contact.number}')"><div class="contact-avatar">${initials}</div><div class="contact-info"><div class="contact-header"><div class="contact-name">${escapeHtml(contact.name)}</div><div class="contact-time">${time}</div></div><div class="contact-preview">${escapeHtml(contact.lastMessage || 'No messages')}</div></div>${contact.unreadCount > 0 ? `<div class="unread-badge">${contact.unreadCount}</div>` : ''}</div>`;
            }).join('');
        }
        function selectContact(number) {
            state.activeContact = number;
            const contact = state.contacts[number];
            document.getElementById('chatName').textContent = contact.name;
            document.getElementById('chatAvatar').textContent = getInitials(contact.name);
            document.getElementById('chatStatus').textContent = '+' + contact.number;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            if (contact.unreadCount > 0) { contact.unreadCount = 0; saveContactsToStorage(); fetch(`/api/mark-read/${number}`, { method: 'POST' }); renderContacts(); }
            if (window.innerWidth <= 768) { document.getElementById('sidebar').classList.remove('mobile-visible'); document.getElementById('chatContainer').classList.add('mobile-visible'); }
            loadMessages(number);
        }
        function showSidebar() { document.getElementById('sidebar').classList.add('mobile-visible'); document.getElementById('chatContainer').classList.remove('mobile-visible'); }
        async function loadMessages(number) { try { const response = await fetch(`/api/messages/${number}`); const data = await response.json(); renderMessages(data.messages || []); } catch (error) {} }
        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            if (!messages || messages.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div>No messages yet</div></div>'; return; }
            let html = '', lastDate = null;
            messages.forEach((msg) => {
                const date = new Date(msg.timestamp);
                const dateStr = formatDateDivider(date);
                if (dateStr !== lastDate) { html += `<div class="date-divider"><span>${dateStr}</span></div>`; lastDate = dateStr; }
                const time = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                const statusIcon = msg.status === 'read' ? '‚úì‚úì' : msg.status === 'delivered' ? '‚úì‚úì' : '‚úì';
                html += `<div class="message ${msg.type}"><div class="message-bubble"><div class="message-text">${escapeHtml(msg.text)}</div><div class="message-meta"><span class="message-time">${time}</span>${msg.type === 'sent' ? `<span class="message-status ${msg.status || 'sent'}">${statusIcon}</span>` : ''}</div></div></div>`;
            });
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !state.activeContact) return;
            try {
                const response = await fetch('/api/send-message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to: state.activeContact, message: text }) });
                if (response.ok) { input.value = ''; input.style.height = 'auto'; if (state.contacts[state.activeContact]) { state.contacts[state.activeContact].lastMessage = text; state.contacts[state.activeContact].lastMessageTime = Date.now(); saveContactsToStorage(); renderContacts(); } setTimeout(() => loadMessages(state.activeContact), 500); }
            } catch (error) {}
        }
        function pollMessages() { if (state.activeContact) syncContacts(); }
        function openNewChatModal() { document.getElementById('newChatModal').classList.add('active'); }
        function openSettingsModal() { document.getElementById('settingsModal').classList.add('active'); }
        function openQuickRepliesModal() { renderQuickReplies(); document.getElementById('quickRepliesModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        async function createNewChat() {
            const number = document.getElementById('newChatNumber').value.trim();
            const name = document.getElementById('newChatName').value.trim() || number;
            if (!number) { alert('Enter phone number'); return; }
            if (!state.contacts[number]) { state.contacts[number] = { number, name, lastMessage: '', lastMessageTime: Date.now(), unreadCount: 0 }; await fetch(`/api/contacts/${number}/update`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) }); saveContactsToStorage(); renderContacts(); }
            selectContact(number); closeModal('newChatModal'); document.getElementById('newChatNumber').value = ''; document.getElementById('newChatName').value = '';
        }
        function requestNotificationPermission() { if ('Notification' in window && Notification.permission === 'default') Notification.requestPermission(); }
        function toggleSound() { state.settings.soundEnabled = document.getElementById('soundToggle').checked; localStorage.setItem('whatsappSettings', JSON.stringify(state.settings)); }
        function toggleDesktopNotif() { state.settings.desktopNotifEnabled = document.getElementById('desktopNotifToggle').checked; localStorage.setItem('whatsappSettings', JSON.stringify(state.settings)); }
        function renderQuickReplies() {
            const list = document.getElementById('quickRepliesList');
            const replies = state.settings.quickReplies || [];
            if (replies.length === 0) { list.innerHTML = '<div class="no-results">No quick replies yet</div>'; return; }
            list.innerHTML = replies.map((reply, index) => `<div class="input-group"><label>Reply ${index + 1}</label><input type="text" value="${escapeHtml(reply.title)}" onchange="updateQuickReply(${index}, 'title', this.value)" placeholder="Title"><textarea onchange="updateQuickReply(${index}, 'text', this.value)" placeholder="Message">${escapeHtml(reply.text)}</textarea></div>`).join('');
        }
        function addQuickReply() { if (!state.settings.quickReplies) state.settings.quickReplies = []; state.settings.quickReplies.push({ title: 'New Reply', text: '' }); localStorage.setItem('whatsappSettings', JSON.stringify(state.settings)); renderQuickReplies(); }
        function updateQuickReply(index, field, value) { state.settings.quickReplies[index][field] = value; localStorage.setItem('whatsappSettings', JSON.stringify(state.settings)); }
        function toggleQuickReplies() { document.getElementById('quickRepliesPanel').classList.toggle('active'); renderQuickRepliesPanel(); }
        function renderQuickRepliesPanel() {
            const panel = document.getElementById('quickRepliesPanel');
            const replies = state.settings.quickReplies || [];
            if (replies.length === 0) { panel.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-tertiary)">No quick replies</div>'; return; }
            panel.innerHTML = replies.map(reply => `<div class="quick-reply-item" onclick="useQuickReply('${escapeHtml(reply.text)}')"><div class="quick-reply-title">${escapeHtml(reply.title)}</div><div class="quick-reply-text">${escapeHtml(reply.text)}</div></div>`).join('');
        }
        function useQuickReply(text) { document.getElementById('messageInput').value = text; document.getElementById('quickRepliesPanel').classList.remove('active'); }
        function markAsUnread() { if (!state.activeContact) return; if (state.contacts[state.activeContact]) { state.contacts[state.activeContact].unreadCount = 1; saveContactsToStorage(); renderContacts(); } }
        function handleSearch() { renderContacts(); }
        function handleTyping() { const input = document.getElementById('messageInput'); input.style.height = 'auto'; input.style.height = input.scrollHeight + 'px'; clearTimeout(state.typingTimeout); state.typingTimeout = setTimeout(() => {}, 1000); }
        function getInitials(name) { if (!name) return '?'; const parts = name.split(' ').filter(p => p.length > 0); if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase(); return name.substring(0, 2).toUpperCase(); }
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000) return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            if (diff < 604800000) return date.toLocaleDateString('en-US', { weekday: 'short' });
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        function formatDateDivider(date) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            if (msgDate.getTime() === today.getTime()) return 'Today';
            if (msgDate.getTime() === yesterday.getTime()) return 'Yesterday';
            return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
        function showMessage(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = message ? (elementId.includes('success') ? 'success-message show' : 'error-message show') : elementId.includes('success') ? 'success-message' : 'error-message';
            if (message) setTimeout(() => { el.className = elementId.includes('success') ? 'success-message' : 'error-message'; }, 3000);
        }
        document.getElementById('messageInput').addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
