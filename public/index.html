<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Business Dashboard</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-green: #00a884;
            --primary-green-hover: #06cf9c;
            --dark-bg: #0a0f0d;
            --sidebar-bg: #111b21;
            --panel-bg: #202c33;
            --hover-bg: #2a3942;
            --border-color: #2a3942;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --text-tertiary: #667781;
            --message-sent: #005c4b;
            --message-received: #202c33;
            --unread-badge: #25d366;
            --blue-tick: #53bdeb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* LAYOUT */
        .container { display: flex; height: 100vh; }
        .sidebar {
            width: 380px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        /* SIDEBAR HEADER */
        .sidebar-header {
            padding: 18px 20px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header-left h2 {
            font-size: 19px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .status-row {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-secondary);
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .connected { background: var(--primary-green); }
        .disconnected { background: #f15c6d; }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: background 0.2s;
        }

        .icon-btn:hover { background: var(--hover-bg); }

        /* SEARCH + NEW CHAT */
        .search-box {
            padding: 10px 16px;
            background: var(--sidebar-bg);
        }

        .search-input-wrapper { position: relative; }
        .search-input {
            width: 100%;
            padding: 10px 16px 10px 50px;
            background: var(--panel-bg);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-input:focus { outline: 2px solid var(--primary-green); }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: 18px;
        }

        .new-chat-btn {
            margin: 12px 16px;
            padding: 12px;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .new-chat-btn:hover { background: var(--primary-green-hover); }

        /* CONTACT LIST */
        .contacts-list {
            flex: 1;
            overflow-y: auto;
        }

        .contacts-list::-webkit-scrollbar { width: 6px; }
        .contacts-list::-webkit-scrollbar-thumb {
            background: var(--hover-bg);
            border-radius: 3px;
        }

        .contact-item {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 14px;
            position: relative;
        }

        .contact-item:hover { background: var(--panel-bg); }
        .contact-item.active { background: var(--hover-bg); }

        .contact-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-green), #128c7e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .contact-info { flex: 1; min-width: 0; }

        .contact-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .contact-name {
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .contact-time {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .contact-preview {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .unread-badge {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--unread-badge);
            color: var(--dark-bg);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }

        /* CHAT PANEL */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--dark-bg);
        }

        .chat-header {
            padding: 14px 20px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-back-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
        }

        .chat-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-green), #128c7e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .chat-info h2 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .chat-status {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* MESSAGE VIEW */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: radial-gradient(circle at 20% 50%, rgba(0, 168, 132, 0.03) 0%, transparent 50%),
                              radial-gradient(circle at 80% 80%, rgba(0, 168, 132, 0.03) 0%, transparent 50%);
        }

        .messages-container::-webkit-scrollbar { width: 6px; }
        .messages-container::-webkit-scrollbar-thumb {
            background: var(--hover-bg);
            border-radius: 3px;
        }

        .date-divider {
            text-align: center;
            margin: 20px 0;
        }

        .date-divider span {
            background: var(--panel-bg);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .message {
            max-width: 65%;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
        }

        .message.sent { align-self: flex-end; }
        .message.received { align-self: flex-start; }

        .message-bubble {
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .message.sent .message-bubble {
            background: var(--message-sent);
            border-bottom-right-radius: 2px;
        }

        .message.received .message-bubble {
            background: var(--message-received);
            border-bottom-left-radius: 2px;
        }

        .message-text {
            font-size: 14.2px;
            line-height: 1.5;
            margin-bottom: 4px;
            word-wrap: break-word;
        }

        .message-meta {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 4px;
            font-size: 11px;
            color: rgba(255,255,255,0.6);
        }

        .message-status.read { color: var(--blue-tick); }

        /* FOOTER INPUT */
        .input-container {
            padding: 14px 20px;
            background: var(--panel-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 11px 16px;
            background: var(--hover-bg);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            resize: none;
            max-height: 120px;
        }

        .send-btn {
            padding: 11px 24px;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }

        .send-btn:disabled {
            background: var(--hover-bg);
            cursor: not-allowed;
        }

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .sidebar:not(.mobile-visible) { display: none; }
            .sidebar.mobile-visible { display: flex; }
            .chat-container:not(.mobile-visible) { display: none; }
            .chat-container.mobile-visible { display: flex; }
            .mobile-back-btn { display: block; }
            .message { max-width: 80%; }
        }
    </style>
</head>

<body>

    <!-- Force visible debug marker so you know page rendered -->
    <div style="position:fixed;top:8px;left:8px;background:#ff0000;color:#fff;padding:3px 6px;z-index:9999;font-size:12px;">
        LOADED
    </div>

    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-header-left">
                    <h2>Messages</h2>
                    <div class="status-row">
                        <span id="statusIndicator" class="status-indicator disconnected"></span>
                        <span id="statusText">Not Connected</span>
                    </div>
                </div>

                <div class="sidebar-header-right">
                    <button class="icon-btn" onclick="openSettingsModal()">‚öôÔ∏è</button>
                </div>
            </div>

            <div class="search-box">
                <div class="search-input-wrapper">
                    <span class="search-icon">üîç</span>
                    <input id="searchInput" class="search-input" placeholder="Search..." oninput="renderContacts()">
                </div>
            </div>

            <button class="new-chat-btn" onclick="openNewChatModal()">+ New Chat</button>

            <div id="contactsList" class="contacts-list">
                <div class="no-results" style="padding:30px;text-align:center;color:var(--text-tertiary);">
                    No contacts yet
                </div>
            </div>
        </div>

        <!-- CHAT PANEL -->
        <div class="chat-container" id="chatContainer">
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="mobile-back-btn" onclick="showSidebar()">‚Üê</button>
                    <div class="chat-avatar" id="chatAvatar">?</div>
                    <div class="chat-info">
                        <h2 id="chatName">Select a contact</h2>
                        <div class="chat-status" id="chatStatus"></div>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" style="text-align:center;padding-top:40px;color:var(--text-tertiary);">
                    üí¨ Select a contact
                </div>
            </div>

            <div class="input-container">
                <textarea id="messageInput" class="message-input" placeholder="Type a message" disabled></textarea>
                <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>Send</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>Settings</h3>

            <div class="input-group">
                <label>Phone Number ID</label>
                <input id="phoneNumberId" type="text" placeholder="15-digit number">
            </div>

            <div class="input-group">
                <label>Access Token</label>
                <input id="accessToken" type="password" placeholder="Token">
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">Save</button>
            <button class="btn btn-secondary" onclick="closeModal('settingsModal')">Cancel</button>

            <div id="settingsSuccess" class="success-message"></div>
            <div id="settingsError" class="error-message"></div>
        </div>
    </div>

    <!-- NEW CHAT MODAL -->
    <div id="newChatModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>Start New Chat</h3>

            <div class="input-group">
                <label>Phone Number</label>
                <input id="newChatNumber" type="text" placeholder="e.g., 971501234567">
            </div>

            <div class="input-group">
                <label>Contact Name</label>
                <input id="newChatName" type="text" placeholder="Name">
            </div>

            <button class="btn btn-primary" onclick="createNewChat()">Start</button>
            <button class="btn btn-secondary" onclick="closeModal('newChatModal')">Cancel</button>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        let state = {
            contacts: {},
            activeContact: null,
            settings: {
                soundEnabled: true,
                desktopNotifEnabled: true
            }
        };

        const notificationSound =
            new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ4KU6Pn77BdGAg+ltryxnYpBSp+zPDaizsIGGS36+mihEAcLHLG79ydTgwKWKjn6MqCPAYVZ7Lv46tWEAYYh9Xyzn8sBil70fHcjT4I');

        function init() {
            loadSettings();
            loadContacts();
            checkConfig();

            requestNotificationPermission();

            setInterval(syncContacts, 4000);
        }

        function loadSettings() {
            const saved = localStorage.getItem('whatsappSettings');
            if (saved) {
                state.settings = { ...state.settings, ...JSON.parse(saved) };
            }

            const cfg = localStorage.getItem('whatsappApiConfig');
            if (cfg) {
                const { phoneNumberId, accessToken } = JSON.parse(cfg);
                document.getElementById('phoneNumberId').value = phoneNumberId || '';
                document.getElementById('accessToken').value = accessToken || '';
            }
        }

        function saveSettings() {
            const phoneNumberId = document.getElementById('phoneNumberId').value.trim();
            const accessToken = document.getElementById('accessToken').value.trim();

            if (!phoneNumberId || !accessToken) {
                alert('Fill all fields');
                return;
            }

            localStorage.setItem('whatsappApiConfig', JSON.stringify({ phoneNumberId, accessToken }));

            fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phoneNumberId, accessToken })
            })
            .then(() => {
                updateStatus(true);
                closeModal('settingsModal');
            });
        }

        function checkConfig() {
            fetch('/api/config')
                .then(r => r.json())
                .then(d => updateStatus(d.configured));
        }

        function updateStatus(connected) {
            document.getElementById('statusIndicator').className =
                'status-indicator ' + (connected ? 'connected' : 'disconnected');
            document.getElementById('statusText').textContent =
                connected ? 'Connected' : 'Not Connected';
        }

        function loadContacts() {
            const local = localStorage.getItem('whatsappContacts');
            if (local) {
                state.contacts = JSON.parse(local);
                renderContacts();
            }
            syncContacts();
        }

        async function syncContacts() {
            try {
                const res = await fetch('/api/contacts');
                const data = await res.json();

                (data.contacts || []).forEach(contact => {
                    const existing = state.contacts[contact.number];

                    if (!existing) {
                        state.contacts[contact.number] = contact;
                    } else {
                        state.contacts[contact.number] = {
                            ...existing,
                            ...contact
                        };
                    }
                });

                localStorage.setItem('whatsappContacts', JSON.stringify(state.contacts));

                renderContacts();

                if (state.activeContact) {
                    loadMessages(state.activeContact);
                }
            } catch (e) {}
        }

        function renderContacts() {
            const list = document.getElementById('contactsList');
            const contacts = Object.values(state.contacts);

            if (contacts.length === 0) {
                list.innerHTML =
                    '<div style="padding:30px;text-align:center;color:var(--text-tertiary);">No contacts</div>';
                return;
            }

            list.innerHTML = contacts
                .sort((a, b) => (b.lastMessageTime || 0) - (a.lastMessageTime || 0))
                .map(contact => {
                    const initials = getInitials(contact.name);
                    const preview = contact.lastMessage || 'No messages';
                    const time = formatTime(contact.lastMessageTime);
                    const active = state.activeContact === contact.number;

                    return `
                        <div class="contact-item ${active ? 'active' : ''}" onclick="selectContact('${contact.number}')">
                            <div class="contact-avatar">${initials}</div>
                            <div class="contact-info">
                                <div class="contact-header">
                                    <div class="contact-name">${escapeHtml(contact.name)}</div>
                                    <div class="contact-time">${time}</div>
                                </div>
                                <div class="contact-preview">${escapeHtml(preview)}</div>
                            </div>

                            ${
                                contact.unreadCount > 0
                                    ? `<div class="unread-badge">${contact.unreadCount}</div>`
                                    : ''
                            }
                        </div>
                    `;
                })
                .join('');
        }

        function selectContact(number) {
            state.activeContact = number;
            const contact = state.contacts[number];

            document.getElementById('chatName').textContent = contact.name;
            document.getElementById('chatAvatar').textContent = getInitials(contact.name);
            document.getElementById('chatStatus').textContent = '+' + contact.number;

            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            contact.unreadCount = 0;

            fetch(`/api/mark-read/${number}`, { method: 'POST' });

            renderContacts();
            loadMessages(number);

            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-visible');
                document.getElementById('chatContainer').classList.add('mobile-visible');
            }
        }

        async function loadMessages(number) {
            const res = await fetch(`/api/messages/${number}`);
            const data = await res.json();
            renderMessages(data.messages || []);
        }

        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');

            if (!messages.length) {
                container.innerHTML =
                    '<div style="padding:30px;text-align:center;color:var(--text-tertiary);">No messages yet</div>';
                return;
            }

            let html = '';
            let lastDate = null;

            messages.forEach(msg => {
                const date = new Date(msg.timestamp);
                const dateStr = formatDateDivider(date);

                if (dateStr !== lastDate) {
                    html += `<div class="date-divider"><span>${dateStr}</span></div>`;
                    lastDate = dateStr;
                }

                const time = date.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const statusIcon =
                    msg.status === 'read'
                        ? '‚úì‚úì'
                        : msg.status === 'delivered'
                        ? '‚úì‚úì'
                        : '‚úì';

                html += `
                    <div class="message ${msg.type}">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(msg.text)}</div>
                            <div class="message-meta">
                                <span>${time}</span>
                                ${msg.type === 'sent' ? `<span>${statusIcon}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();

            if (!text || !state.activeContact) return;

            const to = state.activeContact;

            const res = await fetch('/api/send-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ to, message: text })
            });

            if (res.ok) {
                input.value = '';

                if (state.contacts[to]) {
                    state.contacts[to].lastMessage = text;
                    state.contacts[to].lastMessageTime = Date.now();
                    localStorage.setItem('whatsappContacts', JSON.stringify(state.contacts));
                    renderContacts();
                }

                setTimeout(() => loadMessages(to), 300);
            }
        }

        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function openNewChatModal() {
            document.getElementById('newChatModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function createNewChat() {
            const number = document.getElementById('newChatNumber').value.trim();
            const name = document.getElementById('newChatName').value.trim() || number;

            if (!number) return alert('Enter phone number');

            if (!state.contacts[number]) {
                state.contacts[number] = {
                    number,
                    name,
                    lastMessage: '',
                    lastMessageTime: Date.now(),
                    unreadCount: 0
                };

                await fetch(`/api/contacts/${number}/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                localStorage.setItem('whatsappContacts', JSON.stringify(state.contacts));
                renderContacts();
            }

            selectContact(number);
            closeModal('newChatModal');

            document.getElementById('newChatNumber').value = '';
            document.getElementById('newChatName').value = '';
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            return (parts[0][0] + (parts[1]?.[0] || '')).toUpperCase();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(ts) {
            if (!ts) return '';
            const date = new Date(ts);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
            if (diff < 86400000)
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            if (diff < 604800000)
                return date.toLocaleDateString('en-US', { weekday: 'short' });

            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateDivider(date) {
            const now = new Date();

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            const msgDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            if (msgDate.getTime() === today.getTime()) return 'Today';
            if (msgDate.getTime() === yesterday.getTime()) return 'Yesterday';

            return date.toLocaleDateString('en-US', {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>
